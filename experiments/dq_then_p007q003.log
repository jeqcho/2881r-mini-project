==========================================
DQ then P007Q003 Two-Stage Pruning
==========================================

Activating virtual environment...
Using Python: /workspace/projects/2881r-mini-project/.venv/bin/python

Loading environment variables from .env...
✓ Loaded environment variables from .env

✓ All required SNIP scores found

Starting experiments...
Total pairs: 4
Base directory: out/experiments/dq_then_p007q003

==========================================

==========================================
Running: d=0.07 (7%) MOST dangerous, q=0.03 (3%)
Experiment directory: out/experiments/dq_then_p007q003/d_7_q_3
Using pre-existing safety SNIP scores (no dynamic computation)
==========================================

torch 2.1.0
transformers 4.35.2
accelerate 0.24.1
# of gpus:  1
Disentangle: True
loading llm model llama2-7b-chat-hf
Loading checkpoint shards:   0%|          | 0/2 [00:00<?, ?it/s]Loading checkpoint shards:  50%|█████     | 1/2 [00:26<00:26, 26.18s/it]Loading checkpoint shards: 100%|██████████| 2/2 [00:34<00:00, 15.96s/it]Loading checkpoint shards: 100%|██████████| 2/2 [00:34<00:00, 17.49s/it]
use device  cuda:0
================================================================================
DQ then P007Q003 Two-Stage Pruning
Stage 1: d=7.0%, q=3.0%
Stage 2: p=7%, q=3%
================================================================================

================================================================================
DQ then P007Q003 Two-Stage Pruning
================================================================================
Stage 1: Prune top d=7.0% danger neurons NOT in top q=3.0% utility
Stage 2: Use PRE-EXISTING safety SNIP scores, then prune p=7.0%, q=3.0%

Storage paths:
  Stage 1 model: out/experiments/dq_then_p007q003/d_7_q_3/stage1_model
  Stage 2 safety scores: Using pre-existing align scores (read-only)
  Stage 2 model: out/experiments/dq_then_p007q003/d_7_q_3/stage2_model
================================================================================

prune every linear layer

[STAGE 1] Pruning d=7.0% danger neurons NOT in q=3.0% utility...
  Stage 1 - pruning layer 0 name self_attn.q_proj
  Stage 1 - pruning layer 0 name self_attn.k_proj
  Stage 1 - pruning layer 0 name self_attn.v_proj
  Stage 1 - pruning layer 0 name self_attn.o_proj
  Stage 1 - pruning layer 0 name mlp.gate_proj
  Stage 1 - pruning layer 0 name mlp.up_proj
  Stage 1 - pruning layer 0 name mlp.down_proj
  Stage 1 - pruning layer 1 name self_attn.q_proj
  Stage 1 - pruning layer 1 name self_attn.k_proj
  Stage 1 - pruning layer 1 name self_attn.v_proj
  Stage 1 - pruning layer 1 name self_attn.o_proj
  Stage 1 - pruning layer 1 name mlp.gate_proj
  Stage 1 - pruning layer 1 name mlp.up_proj
  Stage 1 - pruning layer 1 name mlp.down_proj
  Stage 1 - pruning layer 2 name self_attn.q_proj
  Stage 1 - pruning layer 2 name self_attn.k_proj
  Stage 1 - pruning layer 2 name self_attn.v_proj
  Stage 1 - pruning layer 2 name self_attn.o_proj
  Stage 1 - pruning layer 2 name mlp.gate_proj
  Stage 1 - pruning layer 2 name mlp.up_proj
  Stage 1 - pruning layer 2 name mlp.down_proj
  Stage 1 - pruning layer 3 name self_attn.q_proj
  Stage 1 - pruning layer 3 name self_attn.k_proj
  Stage 1 - pruning layer 3 name self_attn.v_proj
  Stage 1 - pruning layer 3 name self_attn.o_proj
  Stage 1 - pruning layer 3 name mlp.gate_proj
  Stage 1 - pruning layer 3 name mlp.up_proj
  Stage 1 - pruning layer 3 name mlp.down_proj
  Stage 1 - pruning layer 4 name self_attn.q_proj
  Stage 1 - pruning layer 4 name self_attn.k_proj
  Stage 1 - pruning layer 4 name self_attn.v_proj
  Stage 1 - pruning layer 4 name self_attn.o_proj
  Stage 1 - pruning layer 4 name mlp.gate_proj
  Stage 1 - pruning layer 4 name mlp.up_proj
  Stage 1 - pruning layer 4 name mlp.down_proj
  Stage 1 - pruning layer 5 name self_attn.q_proj
  Stage 1 - pruning layer 5 name self_attn.k_proj
  Stage 1 - pruning layer 5 name self_attn.v_proj
  Stage 1 - pruning layer 5 name self_attn.o_proj
  Stage 1 - pruning layer 5 name mlp.gate_proj
  Stage 1 - pruning layer 5 name mlp.up_proj
  Stage 1 - pruning layer 5 name mlp.down_proj
  Stage 1 - pruning layer 6 name self_attn.q_proj
  Stage 1 - pruning layer 6 name self_attn.k_proj
  Stage 1 - pruning layer 6 name self_attn.v_proj
  Stage 1 - pruning layer 6 name self_attn.o_proj
  Stage 1 - pruning layer 6 name mlp.gate_proj
  Stage 1 - pruning layer 6 name mlp.up_proj
  Stage 1 - pruning layer 6 name mlp.down_proj
  Stage 1 - pruning layer 7 name self_attn.q_proj
  Stage 1 - pruning layer 7 name self_attn.k_proj
  Stage 1 - pruning layer 7 name self_attn.v_proj
  Stage 1 - pruning layer 7 name self_attn.o_proj
  Stage 1 - pruning layer 7 name mlp.gate_proj
  Stage 1 - pruning layer 7 name mlp.up_proj
  Stage 1 - pruning layer 7 name mlp.down_proj
  Stage 1 - pruning layer 8 name self_attn.q_proj
  Stage 1 - pruning layer 8 name self_attn.k_proj
  Stage 1 - pruning layer 8 name self_attn.v_proj
  Stage 1 - pruning layer 8 name self_attn.o_proj
  Stage 1 - pruning layer 8 name mlp.gate_proj
  Stage 1 - pruning layer 8 name mlp.up_proj
  Stage 1 - pruning layer 8 name mlp.down_proj
  Stage 1 - pruning layer 9 name self_attn.q_proj
  Stage 1 - pruning layer 9 name self_attn.k_proj
  Stage 1 - pruning layer 9 name self_attn.v_proj
  Stage 1 - pruning layer 9 name self_attn.o_proj
  Stage 1 - pruning layer 9 name mlp.gate_proj
  Stage 1 - pruning layer 9 name mlp.up_proj
  Stage 1 - pruning layer 9 name mlp.down_proj
  Stage 1 - pruning layer 10 name self_attn.q_proj
  Stage 1 - pruning layer 10 name self_attn.k_proj
  Stage 1 - pruning layer 10 name self_attn.v_proj
  Stage 1 - pruning layer 10 name self_attn.o_proj
  Stage 1 - pruning layer 10 name mlp.gate_proj
  Stage 1 - pruning layer 10 name mlp.up_proj
  Stage 1 - pruning layer 10 name mlp.down_proj
  Stage 1 - pruning layer 11 name self_attn.q_proj
  Stage 1 - pruning layer 11 name self_attn.k_proj
  Stage 1 - pruning layer 11 name self_attn.v_proj
  Stage 1 - pruning layer 11 name self_attn.o_proj
  Stage 1 - pruning layer 11 name mlp.gate_proj
  Stage 1 - pruning layer 11 name mlp.up_proj
  Stage 1 - pruning layer 11 name mlp.down_proj
  Stage 1 - pruning layer 12 name self_attn.q_proj
  Stage 1 - pruning layer 12 name self_attn.k_proj
  Stage 1 - pruning layer 12 name self_attn.v_proj
  Stage 1 - pruning layer 12 name self_attn.o_proj
  Stage 1 - pruning layer 12 name mlp.gate_proj
  Stage 1 - pruning layer 12 name mlp.up_proj
  Stage 1 - pruning layer 12 name mlp.down_proj
  Stage 1 - pruning layer 13 name self_attn.q_proj
  Stage 1 - pruning layer 13 name self_attn.k_proj
  Stage 1 - pruning layer 13 name self_attn.v_proj
  Stage 1 - pruning layer 13 name self_attn.o_proj
  Stage 1 - pruning layer 13 name mlp.gate_proj
  Stage 1 - pruning layer 13 name mlp.up_proj
  Stage 1 - pruning layer 13 name mlp.down_proj
  Stage 1 - pruning layer 14 name self_attn.q_proj
  Stage 1 - pruning layer 14 name self_attn.k_proj
  Stage 1 - pruning layer 14 name self_attn.v_proj
  Stage 1 - pruning layer 14 name self_attn.o_proj
  Stage 1 - pruning layer 14 name mlp.gate_proj
  Stage 1 - pruning layer 14 name mlp.up_proj
  Stage 1 - pruning layer 14 name mlp.down_proj
  Stage 1 - pruning layer 15 name self_attn.q_proj
  Stage 1 - pruning layer 15 name self_attn.k_proj
  Stage 1 - pruning layer 15 name self_attn.v_proj
  Stage 1 - pruning layer 15 name self_attn.o_proj
  Stage 1 - pruning layer 15 name mlp.gate_proj
  Stage 1 - pruning layer 15 name mlp.up_proj
  Stage 1 - pruning layer 15 name mlp.down_proj
  Stage 1 - pruning layer 16 name self_attn.q_proj
  Stage 1 - pruning layer 16 name self_attn.k_proj
  Stage 1 - pruning layer 16 name self_attn.v_proj
  Stage 1 - pruning layer 16 name self_attn.o_proj
  Stage 1 - pruning layer 16 name mlp.gate_proj
  Stage 1 - pruning layer 16 name mlp.up_proj
  Stage 1 - pruning layer 16 name mlp.down_proj
  Stage 1 - pruning layer 17 name self_attn.q_proj
  Stage 1 - pruning layer 17 name self_attn.k_proj
  Stage 1 - pruning layer 17 name self_attn.v_proj
  Stage 1 - pruning layer 17 name self_attn.o_proj
  Stage 1 - pruning layer 17 name mlp.gate_proj
  Stage 1 - pruning layer 17 name mlp.up_proj
  Stage 1 - pruning layer 17 name mlp.down_proj
  Stage 1 - pruning layer 18 name self_attn.q_proj
  Stage 1 - pruning layer 18 name self_attn.k_proj
  Stage 1 - pruning layer 18 name self_attn.v_proj
  Stage 1 - pruning layer 18 name self_attn.o_proj
  Stage 1 - pruning layer 18 name mlp.gate_proj
  Stage 1 - pruning layer 18 name mlp.up_proj
  Stage 1 - pruning layer 18 name mlp.down_proj
  Stage 1 - pruning layer 19 name self_attn.q_proj
  Stage 1 - pruning layer 19 name self_attn.k_proj
  Stage 1 - pruning layer 19 name self_attn.v_proj
  Stage 1 - pruning layer 19 name self_attn.o_proj
  Stage 1 - pruning layer 19 name mlp.gate_proj
  Stage 1 - pruning layer 19 name mlp.up_proj
  Stage 1 - pruning layer 19 name mlp.down_proj
  Stage 1 - pruning layer 20 name self_attn.q_proj
  Stage 1 - pruning layer 20 name self_attn.k_proj
  Stage 1 - pruning layer 20 name self_attn.v_proj
  Stage 1 - pruning layer 20 name self_attn.o_proj
  Stage 1 - pruning layer 20 name mlp.gate_proj
  Stage 1 - pruning layer 20 name mlp.up_proj
  Stage 1 - pruning layer 20 name mlp.down_proj
  Stage 1 - pruning layer 21 name self_attn.q_proj
  Stage 1 - pruning layer 21 name self_attn.k_proj
  Stage 1 - pruning layer 21 name self_attn.v_proj
  Stage 1 - pruning layer 21 name self_attn.o_proj
  Stage 1 - pruning layer 21 name mlp.gate_proj
  Stage 1 - pruning layer 21 name mlp.up_proj
  Stage 1 - pruning layer 21 name mlp.down_proj
  Stage 1 - pruning layer 22 name self_attn.q_proj
  Stage 1 - pruning layer 22 name self_attn.k_proj
  Stage 1 - pruning layer 22 name self_attn.v_proj
  Stage 1 - pruning layer 22 name self_attn.o_proj
  Stage 1 - pruning layer 22 name mlp.gate_proj
  Stage 1 - pruning layer 22 name mlp.up_proj
  Stage 1 - pruning layer 22 name mlp.down_proj
  Stage 1 - pruning layer 23 name self_attn.q_proj
  Stage 1 - pruning layer 23 name self_attn.k_proj
  Stage 1 - pruning layer 23 name self_attn.v_proj
  Stage 1 - pruning layer 23 name self_attn.o_proj
  Stage 1 - pruning layer 23 name mlp.gate_proj
  Stage 1 - pruning layer 23 name mlp.up_proj
  Stage 1 - pruning layer 23 name mlp.down_proj
  Stage 1 - pruning layer 24 name self_attn.q_proj
  Stage 1 - pruning layer 24 name self_attn.k_proj
  Stage 1 - pruning layer 24 name self_attn.v_proj
  Stage 1 - pruning layer 24 name self_attn.o_proj
  Stage 1 - pruning layer 24 name mlp.gate_proj
  Stage 1 - pruning layer 24 name mlp.up_proj
  Stage 1 - pruning layer 24 name mlp.down_proj
  Stage 1 - pruning layer 25 name self_attn.q_proj
  Stage 1 - pruning layer 25 name self_attn.k_proj
  Stage 1 - pruning layer 25 name self_attn.v_proj
  Stage 1 - pruning layer 25 name self_attn.o_proj
  Stage 1 - pruning layer 25 name mlp.gate_proj
  Stage 1 - pruning layer 25 name mlp.up_proj
  Stage 1 - pruning layer 25 name mlp.down_proj
  Stage 1 - pruning layer 26 name self_attn.q_proj
  Stage 1 - pruning layer 26 name self_attn.k_proj
  Stage 1 - pruning layer 26 name self_attn.v_proj
  Stage 1 - pruning layer 26 name self_attn.o_proj
  Stage 1 - pruning layer 26 name mlp.gate_proj
  Stage 1 - pruning layer 26 name mlp.up_proj
  Stage 1 - pruning layer 26 name mlp.down_proj
  Stage 1 - pruning layer 27 name self_attn.q_proj
  Stage 1 - pruning layer 27 name self_attn.k_proj
  Stage 1 - pruning layer 27 name self_attn.v_proj
  Stage 1 - pruning layer 27 name self_attn.o_proj
  Stage 1 - pruning layer 27 name mlp.gate_proj
  Stage 1 - pruning layer 27 name mlp.up_proj
  Stage 1 - pruning layer 27 name mlp.down_proj
  Stage 1 - pruning layer 28 name self_attn.q_proj
  Stage 1 - pruning layer 28 name self_attn.k_proj
  Stage 1 - pruning layer 28 name self_attn.v_proj
  Stage 1 - pruning layer 28 name self_attn.o_proj
  Stage 1 - pruning layer 28 name mlp.gate_proj
  Stage 1 - pruning layer 28 name mlp.up_proj
  Stage 1 - pruning layer 28 name mlp.down_proj
  Stage 1 - pruning layer 29 name self_attn.q_proj
  Stage 1 - pruning layer 29 name self_attn.k_proj
  Stage 1 - pruning layer 29 name self_attn.v_proj
  Stage 1 - pruning layer 29 name self_attn.o_proj
  Stage 1 - pruning layer 29 name mlp.gate_proj
  Stage 1 - pruning layer 29 name mlp.up_proj
  Stage 1 - pruning layer 29 name mlp.down_proj
  Stage 1 - pruning layer 30 name self_attn.q_proj
