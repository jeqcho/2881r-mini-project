torch 2.1.0
transformers 4.35.2
accelerate 0.24.1
# of gpus:  1
Disentangle: True
loading llm model llama2-7b-chat-hf
Loading checkpoint shards:   0%|          | 0/2 [00:00<?, ?it/s]Loading checkpoint shards:  50%|█████     | 1/2 [01:09<01:09, 69.30s/it]Loading checkpoint shards: 100%|██████████| 2/2 [01:33<00:00, 42.85s/it]Loading checkpoint shards: 100%|██████████| 2/2 [01:33<00:00, 46.82s/it]
use device  cuda:0
================================================================================
DQ then P007Q003 Two-Stage Pruning
Stage 1: d=7.0%, q=3.0%
Stage 2: p=7%, q=3%
================================================================================

================================================================================
DQ then P007Q003 Two-Stage Pruning
================================================================================
Stage 1: Prune top d=7.0% danger neurons NOT in top q=3.0% utility
Stage 2: Use PRE-EXISTING safety SNIP scores, then prune p=7.0%, q=3.0%

Storage paths:
  Stage 1 model: out/experiments/dq_then_p007q003/d_7_q_3/stage1_model
  Stage 2 safety scores: Using pre-existing align scores (read-only)
  Stage 2 model: out/experiments/dq_then_p007q003/d_7_q_3/stage2_model
================================================================================

prune every linear layer

[STAGE 1] Pruning d=7.0% danger neurons NOT in q=3.0% utility...
  Stage 1 - pruning layer 0 name self_attn.q_proj
  Stage 1 - pruning layer 0 name self_attn.k_proj
  Stage 1 - pruning layer 0 name self_attn.v_proj
  Stage 1 - pruning layer 0 name self_attn.o_proj
  Stage 1 - pruning layer 0 name mlp.gate_proj
  Stage 1 - pruning layer 0 name mlp.up_proj
  Stage 1 - pruning layer 0 name mlp.down_proj
  Stage 1 - pruning layer 1 name self_attn.q_proj
  Stage 1 - pruning layer 1 name self_attn.k_proj
  Stage 1 - pruning layer 1 name self_attn.v_proj
  Stage 1 - pruning layer 1 name self_attn.o_proj
  Stage 1 - pruning layer 1 name mlp.gate_proj
  Stage 1 - pruning layer 1 name mlp.up_proj
  Stage 1 - pruning layer 1 name mlp.down_proj
  Stage 1 - pruning layer 2 name self_attn.q_proj
  Stage 1 - pruning layer 2 name self_attn.k_proj
  Stage 1 - pruning layer 2 name self_attn.v_proj
  Stage 1 - pruning layer 2 name self_attn.o_proj
  Stage 1 - pruning layer 2 name mlp.gate_proj
  Stage 1 - pruning layer 2 name mlp.up_proj
  Stage 1 - pruning layer 2 name mlp.down_proj
  Stage 1 - pruning layer 3 name self_attn.q_proj
  Stage 1 - pruning layer 3 name self_attn.k_proj
  Stage 1 - pruning layer 3 name self_attn.v_proj
  Stage 1 - pruning layer 3 name self_attn.o_proj
  Stage 1 - pruning layer 3 name mlp.gate_proj
  Stage 1 - pruning layer 3 name mlp.up_proj
  Stage 1 - pruning layer 3 name mlp.down_proj
  Stage 1 - pruning layer 4 name self_attn.q_proj
  Stage 1 - pruning layer 4 name self_attn.k_proj
  Stage 1 - pruning layer 4 name self_attn.v_proj
  Stage 1 - pruning layer 4 name self_attn.o_proj
  Stage 1 - pruning layer 4 name mlp.gate_proj
  Stage 1 - pruning layer 4 name mlp.up_proj
  Stage 1 - pruning layer 4 name mlp.down_proj
  Stage 1 - pruning layer 5 name self_attn.q_proj
  Stage 1 - pruning layer 5 name self_attn.k_proj
  Stage 1 - pruning layer 5 name self_attn.v_proj
  Stage 1 - pruning layer 5 name self_attn.o_proj
  Stage 1 - pruning layer 5 name mlp.gate_proj
  Stage 1 - pruning layer 5 name mlp.up_proj
  Stage 1 - pruning layer 5 name mlp.down_proj
  Stage 1 - pruning layer 6 name self_attn.q_proj
  Stage 1 - pruning layer 6 name self_attn.k_proj
  Stage 1 - pruning layer 6 name self_attn.v_proj
  Stage 1 - pruning layer 6 name self_attn.o_proj
  Stage 1 - pruning layer 6 name mlp.gate_proj
  Stage 1 - pruning layer 6 name mlp.up_proj
  Stage 1 - pruning layer 6 name mlp.down_proj
  Stage 1 - pruning layer 7 name self_attn.q_proj
  Stage 1 - pruning layer 7 name self_attn.k_proj
  Stage 1 - pruning layer 7 name self_attn.v_proj
  Stage 1 - pruning layer 7 name self_attn.o_proj
  Stage 1 - pruning layer 7 name mlp.gate_proj
  Stage 1 - pruning layer 7 name mlp.up_proj
  Stage 1 - pruning layer 7 name mlp.down_proj
  Stage 1 - pruning layer 8 name self_attn.q_proj
  Stage 1 - pruning layer 8 name self_attn.k_proj
  Stage 1 - pruning layer 8 name self_attn.v_proj
  Stage 1 - pruning layer 8 name self_attn.o_proj
  Stage 1 - pruning layer 8 name mlp.gate_proj
  Stage 1 - pruning layer 8 name mlp.up_proj
  Stage 1 - pruning layer 8 name mlp.down_proj
  Stage 1 - pruning layer 9 name self_attn.q_proj
  Stage 1 - pruning layer 9 name self_attn.k_proj
  Stage 1 - pruning layer 9 name self_attn.v_proj
  Stage 1 - pruning layer 9 name self_attn.o_proj
  Stage 1 - pruning layer 9 name mlp.gate_proj
  Stage 1 - pruning layer 9 name mlp.up_proj
  Stage 1 - pruning layer 9 name mlp.down_proj
  Stage 1 - pruning layer 10 name self_attn.q_proj
  Stage 1 - pruning layer 10 name self_attn.k_proj
  Stage 1 - pruning layer 10 name self_attn.v_proj
  Stage 1 - pruning layer 10 name self_attn.o_proj
  Stage 1 - pruning layer 10 name mlp.gate_proj
  Stage 1 - pruning layer 10 name mlp.up_proj
  Stage 1 - pruning layer 10 name mlp.down_proj
  Stage 1 - pruning layer 11 name self_attn.q_proj
  Stage 1 - pruning layer 11 name self_attn.k_proj
  Stage 1 - pruning layer 11 name self_attn.v_proj
  Stage 1 - pruning layer 11 name self_attn.o_proj
  Stage 1 - pruning layer 11 name mlp.gate_proj
  Stage 1 - pruning layer 11 name mlp.up_proj
  Stage 1 - pruning layer 11 name mlp.down_proj
  Stage 1 - pruning layer 12 name self_attn.q_proj
  Stage 1 - pruning layer 12 name self_attn.k_proj
  Stage 1 - pruning layer 12 name self_attn.v_proj
  Stage 1 - pruning layer 12 name self_attn.o_proj
  Stage 1 - pruning layer 12 name mlp.gate_proj
  Stage 1 - pruning layer 12 name mlp.up_proj
  Stage 1 - pruning layer 12 name mlp.down_proj
  Stage 1 - pruning layer 13 name self_attn.q_proj
  Stage 1 - pruning layer 13 name self_attn.k_proj
  Stage 1 - pruning layer 13 name self_attn.v_proj
  Stage 1 - pruning layer 13 name self_attn.o_proj
  Stage 1 - pruning layer 13 name mlp.gate_proj
  Stage 1 - pruning layer 13 name mlp.up_proj
  Stage 1 - pruning layer 13 name mlp.down_proj
  Stage 1 - pruning layer 14 name self_attn.q_proj
  Stage 1 - pruning layer 14 name self_attn.k_proj
  Stage 1 - pruning layer 14 name self_attn.v_proj
  Stage 1 - pruning layer 14 name self_attn.o_proj
  Stage 1 - pruning layer 14 name mlp.gate_proj
  Stage 1 - pruning layer 14 name mlp.up_proj
  Stage 1 - pruning layer 14 name mlp.down_proj
  Stage 1 - pruning layer 15 name self_attn.q_proj
  Stage 1 - pruning layer 15 name self_attn.k_proj
  Stage 1 - pruning layer 15 name self_attn.v_proj
  Stage 1 - pruning layer 15 name self_attn.o_proj
  Stage 1 - pruning layer 15 name mlp.gate_proj
  Stage 1 - pruning layer 15 name mlp.up_proj
  Stage 1 - pruning layer 15 name mlp.down_proj
  Stage 1 - pruning layer 16 name self_attn.q_proj
  Stage 1 - pruning layer 16 name self_attn.k_proj
  Stage 1 - pruning layer 16 name self_attn.v_proj
  Stage 1 - pruning layer 16 name self_attn.o_proj
  Stage 1 - pruning layer 16 name mlp.gate_proj
  Stage 1 - pruning layer 16 name mlp.up_proj
  Stage 1 - pruning layer 16 name mlp.down_proj
  Stage 1 - pruning layer 17 name self_attn.q_proj
  Stage 1 - pruning layer 17 name self_attn.k_proj
  Stage 1 - pruning layer 17 name self_attn.v_proj
  Stage 1 - pruning layer 17 name self_attn.o_proj
  Stage 1 - pruning layer 17 name mlp.gate_proj
  Stage 1 - pruning layer 17 name mlp.up_proj
  Stage 1 - pruning layer 17 name mlp.down_proj
  Stage 1 - pruning layer 18 name self_attn.q_proj
  Stage 1 - pruning layer 18 name self_attn.k_proj
  Stage 1 - pruning layer 18 name self_attn.v_proj
  Stage 1 - pruning layer 18 name self_attn.o_proj
  Stage 1 - pruning layer 18 name mlp.gate_proj
  Stage 1 - pruning layer 18 name mlp.up_proj
  Stage 1 - pruning layer 18 name mlp.down_proj
  Stage 1 - pruning layer 19 name self_attn.q_proj
  Stage 1 - pruning layer 19 name self_attn.k_proj
  Stage 1 - pruning layer 19 name self_attn.v_proj
  Stage 1 - pruning layer 19 name self_attn.o_proj
  Stage 1 - pruning layer 19 name mlp.gate_proj
  Stage 1 - pruning layer 19 name mlp.up_proj
  Stage 1 - pruning layer 19 name mlp.down_proj
  Stage 1 - pruning layer 20 name self_attn.q_proj
  Stage 1 - pruning layer 20 name self_attn.k_proj
  Stage 1 - pruning layer 20 name self_attn.v_proj
  Stage 1 - pruning layer 20 name self_attn.o_proj
  Stage 1 - pruning layer 20 name mlp.gate_proj
  Stage 1 - pruning layer 20 name mlp.up_proj
  Stage 1 - pruning layer 20 name mlp.down_proj
  Stage 1 - pruning layer 21 name self_attn.q_proj
  Stage 1 - pruning layer 21 name self_attn.k_proj
  Stage 1 - pruning layer 21 name self_attn.v_proj
  Stage 1 - pruning layer 21 name self_attn.o_proj
  Stage 1 - pruning layer 21 name mlp.gate_proj
  Stage 1 - pruning layer 21 name mlp.up_proj
  Stage 1 - pruning layer 21 name mlp.down_proj
  Stage 1 - pruning layer 22 name self_attn.q_proj
  Stage 1 - pruning layer 22 name self_attn.k_proj
  Stage 1 - pruning layer 22 name self_attn.v_proj
  Stage 1 - pruning layer 22 name self_attn.o_proj
  Stage 1 - pruning layer 22 name mlp.gate_proj
  Stage 1 - pruning layer 22 name mlp.up_proj
  Stage 1 - pruning layer 22 name mlp.down_proj
  Stage 1 - pruning layer 23 name self_attn.q_proj
  Stage 1 - pruning layer 23 name self_attn.k_proj
  Stage 1 - pruning layer 23 name self_attn.v_proj
  Stage 1 - pruning layer 23 name self_attn.o_proj
  Stage 1 - pruning layer 23 name mlp.gate_proj
  Stage 1 - pruning layer 23 name mlp.up_proj
  Stage 1 - pruning layer 23 name mlp.down_proj
  Stage 1 - pruning layer 24 name self_attn.q_proj
  Stage 1 - pruning layer 24 name self_attn.k_proj
  Stage 1 - pruning layer 24 name self_attn.v_proj
  Stage 1 - pruning layer 24 name self_attn.o_proj
  Stage 1 - pruning layer 24 name mlp.gate_proj
  Stage 1 - pruning layer 24 name mlp.up_proj
  Stage 1 - pruning layer 24 name mlp.down_proj
  Stage 1 - pruning layer 25 name self_attn.q_proj
  Stage 1 - pruning layer 25 name self_attn.k_proj
  Stage 1 - pruning layer 25 name self_attn.v_proj
  Stage 1 - pruning layer 25 name self_attn.o_proj
  Stage 1 - pruning layer 25 name mlp.gate_proj
  Stage 1 - pruning layer 25 name mlp.up_proj
  Stage 1 - pruning layer 25 name mlp.down_proj
  Stage 1 - pruning layer 26 name self_attn.q_proj
  Stage 1 - pruning layer 26 name self_attn.k_proj
  Stage 1 - pruning layer 26 name self_attn.v_proj
  Stage 1 - pruning layer 26 name self_attn.o_proj
  Stage 1 - pruning layer 26 name mlp.gate_proj
  Stage 1 - pruning layer 26 name mlp.up_proj
  Stage 1 - pruning layer 26 name mlp.down_proj
  Stage 1 - pruning layer 27 name self_attn.q_proj
  Stage 1 - pruning layer 27 name self_attn.k_proj
  Stage 1 - pruning layer 27 name self_attn.v_proj
  Stage 1 - pruning layer 27 name self_attn.o_proj
  Stage 1 - pruning layer 27 name mlp.gate_proj
  Stage 1 - pruning layer 27 name mlp.up_proj
  Stage 1 - pruning layer 27 name mlp.down_proj
  Stage 1 - pruning layer 28 name self_attn.q_proj
  Stage 1 - pruning layer 28 name self_attn.k_proj
  Stage 1 - pruning layer 28 name self_attn.v_proj
  Stage 1 - pruning layer 28 name self_attn.o_proj
  Stage 1 - pruning layer 28 name mlp.gate_proj
  Stage 1 - pruning layer 28 name mlp.up_proj
  Stage 1 - pruning layer 28 name mlp.down_proj
  Stage 1 - pruning layer 29 name self_attn.q_proj
  Stage 1 - pruning layer 29 name self_attn.k_proj
  Stage 1 - pruning layer 29 name self_attn.v_proj
  Stage 1 - pruning layer 29 name self_attn.o_proj
  Stage 1 - pruning layer 29 name mlp.gate_proj
  Stage 1 - pruning layer 29 name mlp.up_proj
  Stage 1 - pruning layer 29 name mlp.down_proj
  Stage 1 - pruning layer 30 name self_attn.q_proj
  Stage 1 - pruning layer 30 name self_attn.k_proj
  Stage 1 - pruning layer 30 name self_attn.v_proj
  Stage 1 - pruning layer 30 name self_attn.o_proj
  Stage 1 - pruning layer 30 name mlp.gate_proj
  Stage 1 - pruning layer 30 name mlp.up_proj
  Stage 1 - pruning layer 30 name mlp.down_proj
  Stage 1 - pruning layer 31 name self_attn.q_proj
  Stage 1 - pruning layer 31 name self_attn.k_proj
  Stage 1 - pruning layer 31 name self_attn.v_proj
  Stage 1 - pruning layer 31 name self_attn.o_proj
  Stage 1 - pruning layer 31 name mlp.gate_proj
  Stage 1 - pruning layer 31 name mlp.up_proj
  Stage 1 - pruning layer 31 name mlp.down_proj
✓ Stage 1 complete: Pruned 7.0% danger neurons (excluding 3.0% utility)

Saving Stage 1 model to out/experiments/dq_then_p007q003/d_7_q_3/stage1_model...
✓ Stage 1 model saved

[STAGE 2] Computing safety SNIP scores on Stage 1 model...
Dataset: align
Save path: None

Loading Stage 1 model from out/experiments/dq_then_p007q003/d_7_q_3/stage1_model...
Loading checkpoint shards:   0%|          | 0/3 [00:00<?, ?it/s]Loading checkpoint shards:  33%|███▎      | 1/3 [00:01<00:02,  1.03s/it]Loading checkpoint shards:  67%|██████▋   | 2/3 [00:02<00:01,  1.01s/it]Loading checkpoint shards: 100%|██████████| 3/3 [00:02<00:00,  1.13it/s]Loading checkpoint shards: 100%|██████████| 3/3 [00:02<00:00,  1.08it/s]
Computing safety SNIP scores...
loading calibdation data align
dataset loading complete
enabling grad for  model.layers.0.self_attn.q_proj
enabling grad for  model.layers.0.self_attn.k_proj
enabling grad for  model.layers.0.self_attn.v_proj
enabling grad for  model.layers.0.self_attn.o_proj
enabling grad for  model.layers.0.mlp.gate_proj
enabling grad for  model.layers.0.mlp.up_proj
enabling grad for  model.layers.0.mlp.down_proj
pruning: model.layers.0.self_attn.q_proj
layer 0
Traceback (most recent call last):
  File "/workspace/projects/2881r-mini-project/main.py", line 1043, in <module>
    main()
  File "/workspace/projects/2881r-mini-project/main.py", line 308, in main
    prune_wandg_dq_then_pq(
  File "/workspace/projects/2881r-mini-project/lib/prune.py", line 2493, in prune_wandg_dq_then_pq
    prune_wandg(
  File "/workspace/projects/2881r-mini-project/lib/model_wrapper.py", line 326, in prune_wandg
    _prune_core(
  File "/workspace/projects/2881r-mini-project/lib/model_wrapper.py", line 394, in _prune_core
    save_folder = os.path.join(
                  ^^^^^^^^^^^^^
  File "<frozen posixpath>", line 76, in join
TypeError: expected str, bytes or os.PathLike object, not NoneType
